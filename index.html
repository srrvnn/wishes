<!DOCTYPE html>

<html>

<head>

    <title>AWS SDK for JavaScript - Sample Application</title>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>

</head>

<body>

      <h1>Recorder.js simple WAV export example</h1>

      <p>Make sure you are using a recent version of Google Chrome.</p>
      <p>Also before you enable microphone input either plug in headphones or turn the volume down if you want to avoid ear splitting feedback!</p>

      <button onclick="startRecording(this);">record</button>
      <button onclick="stopRecording(this);" disabled>stop</button>

      <h2>Recordings</h2>
      <ul id="recordingslist"></ul>

      <h2>Log</h2>
      <pre id="log"></pre>

      <script>
      function __log(e, data) {
        log.innerHTML += "\n" + e + " " + (data || '');
      }

      var audio_context;
      var recorder;

      function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        __log('Media stream created.');

        // Uncomment if you want the audio to feedback directly
        //input.connect(audio_context.destination);
        //__log('Input connected to audio context destination.');

        recorder = new Recorder(input);
        __log('Recorder initialised.');
      }

      function startRecording(button) {
        recorder && recorder.record();
        button.disabled = true;
        button.nextElementSibling.disabled = false;
        __log('Recording...');
      }

      function stopRecording(button) {
        recorder && recorder.stop();
        button.disabled = true;
        button.previousElementSibling.disabled = false;
        __log('Stopped recording.');

        // create WAV download link using audio data blob
        uploadToS3();

        recorder.clear();
      }

      function uploadToS3() {
        recorder && recorder.exportWAV(function(blob) {
          var url = URL.createObjectURL(blob);
          var li = document.createElement('li');
          var au = document.createElement('audio');
        //   var hf = document.createElement('a');

          au.controls = true;
          au.src = url;
        //   hf.href = url;
        //   hf.download = new Date().toISOString() + '.wav';
        //   hf.innerHTML = hf.download;
          li.appendChild(au);
        //   li.appendChild(hf);
          recordingslist.appendChild(li);

          console.log('blob going in: ', blob);

          var objKey = 'facebook-' + fbUserId + '/recording' + Date.now();

          var params = {

              Key: objKey,

              Body: blob,

              ACL: 'public-read'

          };

          bucket.putObject(params, function (err, data) {

              if (err) {

                  results.innerHTML = 'ERROR: ' + err;

              } else {

                  listObjs();

              }

          });
        });
      }

      window.onload = function init() {
        try {
          // webkit shim
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
          window.URL = window.URL || window.webkitURL;

          audio_context = new AudioContext;
          __log('Audio context set up.');
          __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
        } catch (e) {
          alert('No web audio support in this browser!');
        }

        navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
          __log('No live audio input: ' + e);
        });
      };
      </script>

    <!-- <input type="file" id="file-chooser" /> -->

    <!-- <button id="upload-button" style="display:none">Upload to S3</button> -->

    <div id="results"></div>

    <div id="fb-root"></div>

    <script type="text/javascript">

        var appId = '1172856152725672';

        var roleArn = 'arn:aws:iam::694260833504:role/srrvnn-records-facebook';

        var bucketName = 'srrvnn-records';

        AWS.config.region = 'us-west-2';

        var fbUserId;

        var bucket = new AWS.S3({

            params: {

                Bucket: bucketName

            }

        });

        var fileChooser = document.getElementById('file-chooser');

        var button = document.getElementById('upload-button');

        var results = document.getElementById('results');

        function listObjs() {

            var prefix = 'facebook-' + fbUserId;

            bucket.listObjects({

                Prefix: prefix

            }, function (err, data) {

                if (err) {

                    results.innerHTML = 'ERROR: ' + err;

                } else {

                    var objKeys = "";

                    console.log('blob coming out: ');

                    data.Contents.forEach(function (obj) {

                        objKeys += obj.Key + "<br>";

                        bucket.getObject({

                            Bucket: 'srrvnn-records',
                            Key: obj.Key

                        }, function (err, data) {

                            if (data == null) return;

                            var blob = new Blob([data.Body.buffer]);
                            blob.type = "audio/wav";

                            var url = URL.createObjectURL(blob);
                            var li = document.createElement('li');
                            var au = document.createElement('audio');
                            
                            au.controls = true;
                            au.src = url;
                            li.appendChild(au);
                            recordingslist.appendChild(li);
                        });

                    });

                    // results.innerHTML = objKeys;
                }

            });

        }

        /*!

         * Login to your application using Facebook.

         * Uses the Facebook SDK for JavaScript available here:

         * https://developers.facebook.com/docs/javascript/gettingstarted/

         */

        window.fbAsyncInit = function () {

            FB.init({

                appId: appId

            });

            FB.login(function (response) {

                bucket.config.credentials = new AWS.WebIdentityCredentials({

                    ProviderId: 'graph.facebook.com',

                    RoleArn: roleArn,

                    WebIdentityToken: response.authResponse.accessToken

                });

                fbUserId = response.authResponse.userID;

                // button.style.display = 'block';

            });

        };

         // Load the Facebook SDK asynchronously

        (function (d, s, id) {

            var js, fjs = d.getElementsByTagName(s)[0];

            if (d.getElementById(id)) {

                return;

            }

            js = d.createElement(s);

            js.id = id;

            js.src = "//connect.facebook.net/en_US/all.js";

            fjs.parentNode.insertBefore(js, fjs);

        }(document, 'script', 'facebook-jssdk'));

    </script>

    <script src="../dist/recorder.js"></script>

</body>

</html>
